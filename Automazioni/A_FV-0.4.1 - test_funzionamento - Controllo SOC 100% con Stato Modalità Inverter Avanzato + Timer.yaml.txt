alias: >-
  A_FV-0.4.1 - test_funzionamento - Controllo SOC 100% con Stato Modalit√†
  Inverter Avanzato + Timer
description: >-
  Verifica l'ultimo SOC 100%, calcola i giorni trascorsi e controlla la modalit√†
  di lavoro attuale. Invia notifiche permanenti con istruzioni per mantenere o
  cambiare modalit√† operativa e fornisce una notifica dinamica.
triggers:
  - minutes: /30
    trigger: time_pattern
    enabled: false
actions:
  - variables:
      last_soc_date: "{{ states('input_datetime.inverter_last_battery_full') }}"
      days_since_last_soc: |-
        {% if last_soc_date not in ['unknown', 'unavailable'] %}
          {{ ((now().timestamp() - as_timestamp(last_soc_date)) / 86400) | int }}
        {% else %}
          -1
        {% endif %}
      current_mode: "{{ states('sensor.zcs_mod_operativa') }}"
  - data:
      title: ‚ÑπÔ∏è Stato Attuale Modalit√† Inverter
      message: "üîÑ **Modalit√† attuale dell'inverter**: **{{ current_mode }}**"
      notification_id: inverter_mode_status
    action: persistent_notification.create
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ days_since_last_soc >= 0 and days_since_last_soc < 4 }}"
        sequence:
          - data:
              title: üîã SOC 100% Raggiunto di Recente
              message: Ultimo SOC 100% registrato il **{{ last_soc_date }}**.
              notification_id: soc_100_recent
            action: persistent_notification.create
      - conditions:
          - condition: template
            value_template: "{{ days_since_last_soc >= 4 }}"
        sequence:
          - data:
              title: ‚ö°Ô∏è Ultimo SOC 100% Registrato
              message: Ultimo SOC 100% registrato il **{{ last_soc_date }}**.
              notification_id: soc_100_tou_change
            action: persistent_notification.create
  - delay: "00:00:00.5"
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ days_since_last_soc >= 0 and days_since_last_soc < 4 }}"
          - condition: template
            value_template: "{{ current_mode == 'Mod.Automatica' }}"
        sequence:
          - data:
              title: ‚úÖ Nessuna Modifica Necessaria
              message: |-
                üîç Rilevati meno di **4 giorni** dall'ultimo SOC 100%.
                üîÑ **Modalit√† attuale**: **{{ current_mode }}**
                ‚úÖ **Nessuna modifica alla modalit√† di lavoro necessaria.**
              notification_id: soc_mode_ok
            action: persistent_notification.create
      - conditions:
          - condition: template
            value_template: "{{ days_since_last_soc >= 0 and days_since_last_soc < 4 }}"
          - condition: template
            value_template: "{{ current_mode != 'Mod.Automatica' }}"
        sequence:
          - data:
              title: ‚ö†Ô∏è Cambio Modalit√† Necessario
              message: |-
                üîç Rilevati meno di **4 giorni** dall'ultimo SOC 100%.
                üîÑ **Modalit√† attuale**: **{{ current_mode }}**
                ‚ö† **Necessario modificare la modalit√† di lavoro in AUTOMATICA.**
              notification_id: soc_mode_change_auto
            action: persistent_notification.create
      - conditions:
          - condition: template
            value_template: "{{ days_since_last_soc >= 4 }}"
          - condition: template
            value_template: "{{ current_mode != 'Mod.TOU' }}"
        sequence:
          - data:
              title: ‚ö†Ô∏è Cambio Modalit√† Necessario
              message: >-
                üîç Rilevati pi√π di **4 giorni** dall'ultimo SOC 100%.

                üîÑ **Modalit√† attuale**: **{{ current_mode }}**

                ‚ö† **Necessario modificare la modalit√† di lavoro in TOU per
                forzare la ricarica delle batterie al 100%.**
              notification_id: soc_mode_change_tou
            action: persistent_notification.create
mode: single
